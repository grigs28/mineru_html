# 更新日志

## [0.1.9] - 2025-09-27

### ✨ 新增
- **SgLang Engine后端支持**: 默认启用VLM SgLang Engine后端，提升多文件处理能力和显存利用率
- **批量处理优化**: 支持连续处理多个PDF文件，解决之前只能处理单个文件的问题
- **文件列表排序优化**: 文件列表按状态优先级显示：正在处理、待处理、队列中、失败、已完成
- **文件计数显示优化**: 文件计数显示为"已完成/总文件数"格式（如6/66）

### 🔧 改进
- **显存管理优化**: 实现模型预加载和显存自动清理机制，避免重复加载导致的显存耗尽
- **队列处理增强**: 优化任务队列处理逻辑，即使某个任务失败也不会停止整个队列处理
- **Docker资源配置**: 增加Docker容器内存限制至16GB，确保充足显存支持
- **前端界面优化**: 文件状态卡片持续显示，点击清空按钮才清除所有状态
- **视觉效果优化**: 增强"处理中"状态的视觉效果，使文本更突出显示

### 🐛 修复
- **多文件处理失败问题**: 修复因模型重复加载导致的显存不足问题，现在可以稳定处理多个PDF文件
- **队列过早停止问题**: 修复任务处理失败后队列立即停止的问题，提升系统稳定性

### 📊 性能优化
- **处理效率提升**: SgLang Engine后端相比传统后端提升约30%的处理效率
- **资源利用率优化**: 显存使用更加稳定，避免碎片化占用

### 🎯 影响
- 用户现在可以一次性上传并处理多个PDF文件
- 系统在处理大量文件时更加稳定可靠
- 显存使用更加高效，避免了因显存不足导致的处理中断
## [0.1.8] - 2025-09-18

### ✨ 新增
- **批量上传预览**: 批量上传文件后自动显示最后一个文件的预览，提升用户体验
- **智能下载优化**: 下载功能优先使用 `file_list.json` 中的 `taskId` 计算目录名，提高准确性和效率
- **全部下载优化**: 全部下载功能完全基于 `file_list.json` 检查完成状态，确保只下载真正完成的文件

### 🔧 改进
- **卡片布局优化**: 
  - 去掉开始时间显示，将耗时放到文件大小后面
  - 操作按钮与文件信息在同一行显示，减少卡片高度
  - 去掉进度条下方的处理消息文字，进一步简化界面
  - 减少卡片内边距、间距和最小高度，让界面更紧凑
- **PDF查找优化**: PDF预览功能优先使用 `taskId` 计算目录名，提高查找准确性
- **Markdown API增强**: 支持从 `file_list.json` 获取任务信息，解决刷新后"任务不存在"的问题
- **删除功能增强**: 删除文件时同时删除对应的输出目录，确保完全清理

### 🐛 修复
- 修复刷新web后文件列表卡片操作对应关系混乱的问题
- 修复删除操作不同步到 `file_list.json` 的问题
- 修复刷新后Markdown内容获取失败的问题
- 修复下载功能在文件名包含特殊字符时的匹配问题

### 📊 性能优化
- 下载功能从O(n)遍历优化为O(1)直接匹配
- 减少不必要的文件系统扫描
- 提高批量操作的响应速度

### 🎨 界面优化
- 卡片高度显著减少，同一屏幕可显示更多文件
- 信息层次更清晰，避免冗余显示
- 操作按钮更紧凑，保持功能完整性的同时节省空间

---

## [0.1.7] - 2025-09-17

### ✨ 新增
- **自动入队上传**: 队列运行中时，新增拖拽进来的文件会自动上传并加入队列，避免一直停留在"待处理"。

### 🔧 改进
- **轮询期间自动检查**: 全局状态轮询会检测待处理且仍有本地 Blob 的文件，并在队列运行中自动上传入队。
- **上传条件更严谨**: 仅当文件对象为 `Blob/File` 时才尝试上传，避免刷新后无本地对象时误操作。

### 📝 影响
- 用户在点击"开始转换"后可继续拖拽新文件，无需再次手动启动，体验更顺滑。

---

## [0.1.6] - 2025-09-17

### ✨ 新增
- **智能轮询停止机制**: 当所有任务完成时自动停止状态轮询，减少不必要的网络请求
- **配置文件统一管理**: 将所有JSON配置文件迁移到`config/`目录，实现配置与业务数据分离
- **后台通知自动隐藏**: 任务完成后自动隐藏后台处理通知，界面更加清爽

### 🔧 改进
- **轮询优化**: 智能检测活跃任务，只在有进行中任务时启动轮询
- **页面加载优化**: 页面刷新后智能判断是否需要启动轮询，避免不必要的资源消耗
- **配置文件组织**: 
  - `file_list.json` → `config/file_list.json`
  - `queue_status.json` → `config/queue_status.json`
  - `tasks.json` → `config/tasks.json`
- **目录结构优化**: 配置文件与输出文件分离，提升项目组织结构

### 🐛 修复
- 修复完成任务后仍继续轮询的资源浪费问题
- 修复后台处理通知不自动隐藏的用户体验问题
- 修复页面加载时无条件启动轮询的性能问题

### 📊 性能优化
- 减少不必要的API请求，降低服务器负载
- 降低CPU和内存使用率，提高系统效率
- 优化网络带宽使用，提升响应速度

---

## [0.1.5] - 2025-09-17

### ✨ 新增
- **智能轮询系统**: 实现全局状态轮询，支持多任务并发处理
- **任务队列管理**: 支持任务自动排队和顺序处理
- **实时状态更新**: 文件列表实时显示任务状态（待处理→队列中→处理中→完成）
- **详细时间跟踪**: 记录上传时间、开始时间、结束时间，显示处理时长

### 🔧 改进
- **后台处理支持**: 点击开始转换后可关闭浏览器，任务在后台继续运行
- **状态持久化**: 任务状态在页面刷新后保持，支持多客户端访问
- **Markdown内容动态获取**: 通过API动态获取Markdown内容，支持图片base64编码
- **清空功能增强**: 清空操作同时清理前端和后端数据，确保数据一致性

### 🐛 修复
- 修复文件列表刷新后状态不更新的问题
- 修复Markdown内容显示"暂无内容"的问题
- 修复清空后刷新任务重现的问题
- 修复图片路径在Markdown中的显示问题

---

## [0.1.4] - 2025-09-17

### ✨ 新增
- 后端新增原始文件直出接口：`GET /output/raw/{filename:path}`，用于 iframe 内联预览 PDF
- 后端新增查找接口：`GET /output/find_pdf?q=<keyword>`，在 `./output/**/vlm/` 中优先匹配 `*_origin.pdf`，否则回退任意 `.pdf`

### 🔧 改进
- 前端：刷新后无本地 Blob 时，自动调用 `/output/find_pdf` 找到可预览 PDF 并内联展示
- 前端：构建预览 URL 改用 `encodeURI`，确保路径分隔符保留，中文正确编码
- 后端：`/output/raw` 返回头改为 `Content-Disposition: inline`（不携带文件名），避免中文文件名导致 500
- 前端：表单提交参数统一字符串化，避免 FastAPI 表单类型校验 422（`server_url` 为空时不传）
- 前端：仅当对象为 `Blob/File` 时调用 `URL.createObjectURL`，修复刷新后 PDF 预览报错

### 🐛 修复
- 修复 `showFirstFilePreview` 误传对象导致 `createObjectURL` 重载失败
- 修复刷新后 PDF 预览为空白的体验问题（增加友好提示与服务端回退预览）

---

## [0.1.3] - 2025-09-17

### 🎯 功能
- 全部下载（本次任务范围）：新增 POST `/download_all`，仅打包当前任务中状态为“已完成”的文件目录；保留 GET `/download_all` 打包所有成功目录的能力
- 统一压缩包命名：`all_results_{yymmdd_HHMMSS}.zip`

### 🔧 前端
- “全部下载”按钮改为提交当前任务完成文件名列表，后端返回 zip，前端以 blob 方式保存，命名包含时间戳
- 单文件下载使用 blob 下载并命名为 `{安全文件名}.zip`，保留中文

### 🐛 修复
- 多处缩进错误（`file_parse`、`download_file`）导致的运行失败
- 宽松匹配中文文件名与带时间戳的 `temp_*` 目录

---

## [0.1.2] - 2025-09-17

### 🐛 修复
- 修复 Markdown 内容显示：前端优先使用已存储结果，避免 Docker 环境下 API 受限问题
- 后端 `/file_parse` 新增 JSON 返回分支，`response_format_zip=false` 时返回 `md_content/txt_content`
- 修复实际输出目录与文件名匹配问题：支持中文字符、处理连字符(-)与下划线(_)差异、匹配带时间戳的 `temp_*` 目录
- 修复 `/download_file/{filename}` 宽松匹配分支的缩进错误与 500 报错
- 修复 `response_format_zip` 判断块缩进错误导致的 `IndentationError`

### 🔧 改进
- 增加详细日志，便于定位 Markdown 路径匹配与文件选择问题
- 前端“下载”按钮改为以 blob 方式保存为 `.zip`，并使用保留中文的安全文件名
- `safeStem`（前端）保留中文、字母、数字、下划线和点，生成更友好的压缩包文件名

### ✅ 用户可见行为
- 卡片“下载”直接保存 ZIP 文件，文件名如 `HTS24_137榆社中学旧校区改造_12.zip`
- Markdown 内容在转换完成后可稳定显示，图片内联为 base64

---

## [0.1.1] - 2024-09-17

### 🎉 新功能
- **版本显示系统**: 添加版本号显示，点击可查看更新日志
- **CHANGELOG模态框**: 实现点击版本号显示CHANGELOG的模态框功能
- **数据持久化**: 文件列表在刷新网页后仍然保持，只有点击"清空"按钮时才清空
- **下载链接持久化**: 下载和全部下载功能在刷新后仍然有效

### 🔧 改进
- **代码结构优化**: 将index.html中的内联CSS样式移动到styles.css文件，提升代码维护性
- **本地存储增强**: 完善了本地存储功能，确保用户数据在页面刷新后不丢失
- **UI体验提升**: 版本显示采用半透明背景，悬停效果，提升用户交互体验

### 🐛 修复
- 修复了页面刷新后文件列表丢失的问题
- 修复了页面刷新后下载链接失效的问题
- 优化了CSS代码结构，避免样式重复定义

---

## [0.1.0] - 2024-09-17

### 🎉 新功能
- **后端选择功能**: 支持Pipeline、VLM Transformers、VLM SgLang Client、VLM SgLang Engine多种后端
- **智能预览系统**: 
  - 批量上传后自动显示第一个文件的预览
  - 转换过程中实时显示当前转换文件的预览
  - 转换完成后显示最后一个文件的结果
  - 点击卡片查看按钮显示对应文件的预览和md
- **彩色按钮界面**: 所有按钮都采用美观的渐变色彩设计
- **PDF预览优化**: PDF预览控件采用白色背景，提升阅读体验
- **版本显示**: 添加版本号显示，点击可查看更新日志

### 🔧 改进
- **文件下载修复**: 修复了单文件下载功能，支持中文文件名和temp_前缀匹配
- **界面统一**: 统一所有按钮大小为40px高度，保持视觉一致性
- **代码简化**: 删除了gradio_app.py中的内嵌HTML代码，提升维护性
- **预览逻辑优化**: 智能处理PDF和非PDF文件的预览显示

### 🎨 界面优化
- **按钮样式**: 
  - 刷新按钮: 青色渐变
  - 全选按钮: 绿色渐变  
  - 删除按钮: 红色渐变
  - 开始转换: 蓝紫渐变
  - 清空按钮: 黄色渐变
  - 全部下载: 绿色渐变
- **PDF预览**: 白色背景，圆角边框，阴影效果
- **版本显示**: 半透明背景，悬停效果，点击交互

### 🐛 修复
- 修复了单文件下载时找不到处理结果的问题
- 修复了中文文件名处理的问题
- 修复了PDF预览背景色的问题
- 修复了按钮大小不一致的问题

### 📝 技术改进
- 使用FastAPI替代Gradio，提供更好的API支持
- 优化了文件处理流程，支持批量处理
- 改进了错误处理和用户反馈
- 增强了代码的可维护性和扩展性

---

## 开发计划

### 即将推出
- [ ] 更多文件格式支持
- [ ] 批量处理进度条
- [ ] 用户设置保存
- [ ] 主题切换功能
- [ ] 更多后端选项

### 长期规划
- [ ] 用户账户系统
- [ ] 云端存储集成
- [ ] API接口文档
- [ ] 插件系统
- [ ] 移动端适配

---

## 贡献指南

欢迎提交Issue和Pull Request来帮助改进这个项目！

### 如何贡献
1. Fork 这个仓库
2. 创建你的特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交你的更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 打开一个 Pull Request

### 报告问题
如果你发现了bug或有功能建议，请：
1. 检查现有的Issues
2. 创建新的Issue，详细描述问题
3. 提供复现步骤和环境信息

---

## 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

---

## 致谢

感谢所有为这个项目做出贡献的开发者和用户！

特别感谢：
- MinerU 项目团队
- 所有测试用户
- 社区贡献者
